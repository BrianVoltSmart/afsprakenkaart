<!DOCTYPE html>
<html>
<head>
  <title>Afsprakenkaart (met filters)</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    body { font-family: sans-serif; margin: 0; padding: 0; }
    #controls { padding: 10px; background: #f5f5f5; display: flex; gap: 1rem; align-items: center; flex-wrap: wrap; }
    #map { height: 90vh; width: 100%; }
  </style>
</head>
<body>

<div id="controls">
  <label for="datumSelect">ğŸ“… Datum: </label>
  <select id="datumSelect">
    <option value="">-- Alles --</option>
  </select>

  <label for="operatorSelect">ğŸ‘¤ Operator: </label>
  <select id="operatorSelect">
    <option value="">-- Iedereen --</option>
  </select>
</div>

<div id="map"></div>

<script>
  const sheetURL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQu2tdR_UHXSEhvRq0Sga15iSOq9A6dDFfGrgLmtQ5k4oJW1NsBNb604HSecpGI9gqY5AWXjTvzArJQ/pub?output=csv';
  let map;
  let allMarkers = [];
  let afsprakenData = [];

  async function initMap() {
    map = L.map('map').setView([52.1, 5.1], 7);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: 'Kaartgegevens Â© OpenStreetMap',
      maxZoom: 18,
    }).addTo(map);

    await loadAfspraken();
    buildFilters();
    updateMarkers();
  }

  async function loadAfspraken() {
    const res = await fetch(sheetURL);
    const csvText = await res.text();
    const rows = csvText.split('\n').slice(1);

    afsprakenData = [];

    for (const row of rows) {
      const [datum, medewerker, adres, status] = row.split(',');

      if (!adres || !datum || !medewerker) continue;

      const geoURL = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(adres)}`;
      const geoRes = await fetch(geoURL, { headers: { 'User-Agent': 'afspraken-tool-demo' } });
      const geoData = await geoRes.json();

      if (geoData.length > 0) {
        const { lat, lon } = geoData[0];
        const operators = medewerker.split(',').map(o => o.trim());
        afsprakenData.push({ datum, operators, adres, status, lat: parseFloat(lat), lon: parseFloat(lon) });
      }
    }
  }

  function buildFilters() {
    const datumSelect = document.getElementById('datumSelect');
    const operatorSelect = document.getElementById('operatorSelect');

    // Vul datumfilter
    const uniekeDatums = [...new Set(afsprakenData.map(a => a.datum))].sort();
    uniekeDatums.forEach(d => {
      const opt = document.createElement('option');
      opt.value = d;
      opt.textContent = d;
      datumSelect.appendChild(opt);
    });

    // Vul operatorfilter
    const allOps = afsprakenData.flatMap(a => a.operators);
    const uniekeOperators = [...new Set(allOps)].sort();
    uniekeOperators.forEach(o => {
      const opt = document.createElement('option');
      opt.value = o;
      opt.textContent = o;
      operatorSelect.appendChild(opt);
    });

    datumSelect.addEventListener('change', updateMarkers);
    operatorSelect.addEventListener('change', updateMarkers);
  }

  function updateMarkers() {
    const datum = document.getElementById('datumSelect').value.trim();
    const operator = document.getElementById('operatorSelect').value.trim();

    allMarkers.forEach(marker => map.removeLayer(marker));
    allMarkers = [];

    const gefilterd = afsprakenData.filter(a => {
      const datumMatch = !datum || a.datum.trim() === datum;
      const operatorMatch = !operator || a.operators.includes(operator);
      return datumMatch && operatorMatch;
    });

    gefilterd.forEach(a => {
      const marker = L.marker([a.lat, a.lon]).addTo(map);
      marker.bindPopup(`<strong>${a.operators.join(', ')}</strong><br>${a.adres}<br>${a.datum}<br>Status: ${a.status}`);
      allMarkers.push(marker);
    });
  }

  initMap();
</script>

</body>
</html>
