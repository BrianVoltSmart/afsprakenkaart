<!DOCTYPE html>
<html>
<head>
  <title>Afsprakenkaart met emoji-markers</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Leaflet CSS & JS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    body { font-family: sans-serif; margin:0; background:#121212; color:#eee; }
    #topbar { display:flex; align-items:center; background:#282828; padding:10px 20px; justify-content:space-between;}
    #title{font-weight:700;font-size:1.5rem;}
    #searchContainer{flex:1; text-align:right;}
    #searchInput{padding:6px; border-radius:4px; border:none; background:#333; color:white;}
    #controls{padding:10px 20px; background:#1e1e1e; display:flex;gap:1rem;align-items:center;}
    select{background:#333;color:white;padding:6px;border:none;border-radius:4px;}
    #map{height:70vh;}
    .emoji-div-icon{font-size:24px;line-height:24px;text-align:center;}
    #legend{padding:10px 20px;background:#1e1e1e;display:flex;gap:1rem;flex-wrap:wrap;}
    .legend-item{display:flex;align-items:center;gap:0.5rem;}
    .legend-icon{font-size:1.2rem;}
    #afstandInfo{padding:10px 20px;background:#1e1e1e;}
  </style>
</head>
<body>
  <div id="topbar">
    <div id="title">Afsprakenkaart</div>
    <div id="searchContainer"><input type="text" id="searchInput" placeholder="üîç Zoek adres of operator..." /></div>
  </div>

  <div id="controls">
    <label>üìÖ Datum:</label><select id="datumSelect"><option value="">-- Alles --</option></select>
    <label>üë§ Operator:</label><select id="operatorSelect"><option value="">-- Iedereen --</option></select>
  </div>

  <div id="map"></div>
  <div id="legend"></div>
  <div id="afstandInfo"></div>

  <script>
    const sheetURL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQu2tdR_UHXSEhvRq0Sga15iSOq9A6dDFfGrgLmtQ5k4oJW1NsBNb604HSecpGI9gqY5AWXjTvzArJQ/pub?output=csv";

    const operatorEmoji = { Roelof:"üë®‚Äçüåæ", Jesse:"üöÄ", Chanice:"‚ú®", Karlijn:"üå∏", Civan:"üü¢", Keith:"üü°", Gio:"üëë" };

    let map, allMarkers = [], afsprakenData = [], selectedMarkers = [], routeLine;

    async function initMap(){
      map = L.map("map").setView([52.1, 5.1],7);
      L.tileLayer("https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png",{ maxZoom:18 }).addTo(map);

      await loadAfspraken();
      buildFilters(); buildLegend(); updateMarkers();

      document.getElementById("searchInput").addEventListener("input", zoekFunctie);
    }

    async function loadAfspraken(){
      const res = await fetch(sheetURL), text = await res.text(), rows = text.split("\n").slice(1);
      afsprakenData = [];
      for(let row of rows){
        const cols = row.split(","), datum=cols[0]?.trim(), medewerker=cols[1]?.trim(), adres=cols[2]?.trim(),
          status=cols[3]?.trim(), tijd=cols[4]?.trim(), lat=parseFloat(cols[7]), lon=parseFloat(cols[8]);
        if(!datum||!medewerker||!adres||!tijd||isNaN(lat)||isNaN(lon)) continue;
        afsprakenData.push({ datum, tijd, operators:medewerker.split(",").map(o=>o.trim()), adres, status, lat, lon, datumObj:parseDatum(datum)});
      }
    }

    function parseDatum(d){ const [d1,m,y]=d.split("-").map(Number); return new Date(y,m-1,d1); }

    function buildFilters(){
      const ds=document.getElementById("datumSelect"), os=document.getElementById("operatorSelect");
      [...new Set(afsprakenData.map(a=>a.datum))].sort((a,b)=>parseDatum(a)-parseDatum(b)).forEach(d=>{
        let o=document.createElement("option"); o.value=d; o.text=d; ds.append(o);
      });
      [...new Set(afsprakenData.flatMap(a=>a.operators))].sort().forEach(o=>{
        let opt=document.createElement("option"); opt.value=o; opt.text=o; os.append(opt);
      });
      ds.addEventListener("change", updateMarkers);
      os.addEventListener("change", updateMarkers);
    }

    function buildLegend(){
      const lg=document.getElementById("legend"); lg.innerHTML="<strong>Legenda:</strong>";
      Object.entries(operatorEmoji).forEach(([n,e])=>{
        let div=document.createElement("div"); div.className="legend-item";
        div.innerHTML=`<span class="legend-icon">${e}</span>${n}`; lg.append(div);
      });
    }

    function updateMarkers(){
      allMarkers.forEach(m=>map.removeLayer(m)); allMarkers=[]; selectedMarkers=[]; clearRouteInfo();

      const selectedDate=document.getElementById("datumSelect").value;
      const selectedOp=document.getElementById("operatorSelect").value;

      const filtered = afsprakenData.filter(a=> (!selectedDate||a.datum===selectedDate) && (!selectedOp||a.operators.includes(selectedOp)));
      const grouped = {};
      filtered.forEach(a=>{ a.operators.forEach(o=>{ const key=a.datum+"_"+o; grouped[key] ||= []; grouped[key].push(a); });});
      Object.values(grouped).forEach(list=>list.sort((a,b)=>a.tijd.localeCompare(b.tijd)));

      filtered.forEach(a=>{
        const e=operatorEmoji[a.operators[0]]||"‚ö™";
        const g=grouped[a.datum+"_"+a.operators[0]];
        const idx=g.length>1?g.indexOf(a)+1+". ":"";
        const adresBez = a.adres.split(" ").filter(w=>!/^\d{4}\s?[A-Z]{2}$/i.test(w)).join(" ");
        const mapsLink=`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(a.lat+","+a.lon)}`;
        const m = L.marker([a.lat,a.lon],{ icon:L.divIcon({className:"emoji-div-icon", html:e, iconSize:[24,24],iconAnchor:[12,12]}) }).addTo(map);
        m.bindPopup(`<strong>${idx}${a.operators.join(", ")}</strong><br>${adresBez}<br>${a.datum} ${a.tijd}<br>${a.status?`Status: ${a.status}<br>`:""}<a href="${mapsLink}" target="_blank">üìç Open in Google Maps</a>`);
        m.on("click",()=>onMarkerClick(m,a));
        allMarkers.push(m);
      });
    }

    async function onMarkerClick(marker, data){
      selectedMarkers.push({ marker, data });
      if(selectedMarkers.length===2){
        const [first, second] = selectedMarkers;
        const ll1=first.marker.getLatLng(), ll2=second.marker.getLatLng();
        drawRoute(ll1, ll2);
      } else if(selectedMarkers.length>2){
        selectedMarkers=[{marker,data}];
        clearRoute();
      }
    }

    async function drawRoute(p1, p2){
      clearRoute();
      const url=`https://router.project-osrm.org/route/v1/driving/${p1.lng},${p1.lat};${p2.lng},${p2.lat}?overview=full&geometries=geojson`;
      const res = await fetch(url), json = await res.json();
      if(json.code==="Ok"){
        const route=json.routes[0], distKm=(route.distance/1000).toFixed(2), durMin=(route.duration/60);
        routeLine=L.geoJSON(route.geometry,{color:"#4fc3f7",weight:4}).addTo(map);
        const arrive=new Date(Date.now()+route.duration*1000);
        document.getElementById("afstandInfo").innerHTML =
          `üõ£Ô∏è Route: ${distKm}‚ÄØkm ‚Ä¢ üöó Reistijd: ${Math.round(durMin)}‚ÄØmin ‚Ä¢ Aankomst tweede afspraak om ${arrive.getHours().toString().padStart(2,'0')}:${arrive.getMinutes().toString().padStart(2,'0')}`;
      }
    }

    function clearRoute(){ if(routeLine) map.removeLayer(routeLine); clearRouteInfo(); }

    function clearRouteInfo(){ document.getElementById("afstandInfo").textContent=""; }

    function zoekFunctie(e){
      const term=e.target.value.toLowerCase();
      allMarkers.forEach(m=>{
        const txt=m.getPopup().getContent().toLowerCase();
        m.setOpacity(txt.includes(term)?1:0.2);
      });
    }

    initMap();
  </script>
</body>
</html>
